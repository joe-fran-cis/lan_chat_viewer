<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LAN Chat ‚Äî Viewer (Full History)</title>
    <link rel="icon" type="image/png" href="icon/chat-box.ico">
    <!-- <link rel="icon" -->
    <!-- href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E%F0%9F%92%AC%3C/text%3E%3C/svg%3E"> -->


    <style>
        body {
            font-family: Segoe UI, Roboto, Arial, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #09121a;
            color: #e6eef6;
        }

        #header {
            padding: 10px;
            background: #0f2630;
            color: #6fd6ff;
            text-align: center;
            font-weight: 600;
        }

        #status {
            padding: 12px;
            text-align: center;
            color: #bcd;
            min-height: 44px;
        }

        #chat-window {
            flex: 1;
            overflow: auto;
            padding: 12px;
        }

        .message-container {
            margin-bottom: 10px;
            display: flex;
        }

        .my-message {
            justify-content: flex-end;
        }

        .other-message {
            justify-content: flex-start;
        }

        .bubble {
            /* Compactness: Reduced max-width for desktop view */
            max-width: 30%;
            padding: 10px 14px;
            border-radius: 18px;

            /* --- Wrapping Fix --- */
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;

            font-size: 0.95em;
            line-height: 1.4;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            text-align: left;
            /* Default: Mob/My Message (Blue/Cyan gradient) */
            background: linear-gradient(to right, #00f2fe, #4facfe);
            color: #000;
        }

        .other-message .bubble {
            /* PC/Other Message (Darker blue gradient) */
            background: linear-gradient(to right, #005691, #003050);
            color: white;
        }

        /* Style for links inside the bubble */
        .bubble a {
            color: inherit;
            text-decoration: underline;
        }

        .ts {
            display: block;
            margin-top: 6px;
            font-size: 0.75em;
            opacity: .8;
            text-align: right;
        }

        /* WhatsApp DATE style */
        .date-sep {
            display: inline-block;
            margin: 15px auto;
            padding: 6px 14px;
            background: #262d33;
            color: #cfd3d7;
            font-size: 0.78em;
            border-radius: 12px;
            text-align: center;
        }

        #controls {
            padding: 8px;
            background: #07121a;
            border-top: 1px solid #0f2736;
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
        }

        button {
            padding: 8px 12px;
            border-radius: 6px;
            border: 0;
            background: #1976d2;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #1565c0;
        }

        @media (max-width: 600px) {
            .bubble {
                /* Compactness: Reduced max-width for mobile view */
                max-width: 30%;
            }
        }
    </style>
</head>

<body>
    <div id="status" style="display:none;"></div>

    <div id="chat-window"></div>

    <div id="controls">
        <button id="refresh">Refresh</button>
        <div id="last-sync" style="font-size: 0.9em; color:#9ab;">Last sync: ‚Äî</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <script>
        // DOM Element references
        const statusEl = document.getElementById("status");
        const chatWindow = document.getElementById("chat-window");
        const lastSyncEl = document.getElementById("last-sync");
        const refreshBtn = document.getElementById("refresh");

        // ... (Keep utility functions: escapeHtml, linkify, normalizeToArray, formatDateForDisplay, renderDateSeparator, renderMessage) ...

        function escapeHtml(t) {
            return t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        function linkify(text) {
            const urlRegex = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[\S]+(\b|$))|(\b[\w]+(\.[\w]{2,}){1,3}\b)/gim;
            const escapedText = escapeHtml(text);

            const linkedText = escapedText.replace(urlRegex, (url) => {
                let href = url;
                if (!url.match(/^(https?|ftp):\/\//i) && url.indexOf('.') > -1) {
                    href = 'http://' + url;
                }
                return `<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
            });

            return linkedText;
        }

        function normalizeToArray(obj) {
            if (!obj || typeof obj !== 'object') return [];

            const values = Object.values(obj);
            return values.filter(item => {
                const isObject = typeof item === 'object' && item !== null;
                const isMessage = isObject && (item.message || item.msg);
                return isMessage;
            });
        }

        function formatDateForDisplay(dateStr) {
            const d = new Date(dateStr);
            if (isNaN(d)) return dateStr;

            const today = new Date();
            const yest = new Date();
            yest.setDate(today.getDate() - 1);

            const sameDay = (a, b) => a.toDateString() === b.toDateString();

            if (sameDay(d, today)) return "Today";
            if (sameDay(d, yest)) return "Yesterday";

            return d.toLocaleDateString("en-US", {
                day: "2-digit",
                month: "short",
                year: "numeric"
            });
        }

        function renderDateSeparator(dateString) {
            const wrap = document.createElement("div");
            wrap.style.display = "flex";
            wrap.style.justifyContent = "center";

            const sep = document.createElement("div");
            sep.className = "date-sep";
            sep.textContent = formatDateForDisplay(dateString);

            wrap.appendChild(sep);
            chatWindow.appendChild(wrap);
        }

        function renderMessage(msg) {
            const isMyMessage = msg.source === "Mob";
            const container = document.createElement("div");
            container.className =
                "message-container " + (isMyMessage ? "my-message" : "other-message");

            const bubble = document.createElement("div");
            bubble.className = "bubble";

            const text = msg.message ?? msg.msg ?? "";
            const time = msg.time ?? "";

            const linkedText = linkify(text);

            bubble.innerHTML =
                linkedText + `<span class="ts">${escapeHtml(time)}</span>`;

            container.appendChild(bubble);
            chatWindow.appendChild(container);
        }

        // =========================================================================
        // CORE DATA LOADING FUNCTION
        // =========================================================================

        async function loadLatest() {
            // ... (rest of the loadLatest function remains the same) ...

            console.log("Starting full history data load...");
            chatWindow.innerHTML = "";
            let allMessages = [];

            const db = firebase.database();

            // --- Querying ALL log entries ---
            const snap = await db.ref("/chat_logs").once("value");

            const syncDate = new Date();

            if (!snap.exists()) {
                lastSyncEl.textContent = "Last sync: No chat logs found";
                return;
            }

            snap.forEach(childSnapshot => {
                const nodeData = childSnapshot.val();
                const messageBlock = nodeData.data ?? nodeData;

                let messagesFromNode = [];

                if (messageBlock && (messageBlock.message || messageBlock.msg)) {
                    messagesFromNode = [messageBlock];
                } else {
                    messagesFromNode = normalizeToArray(messageBlock);
                }

                allMessages = allMessages.concat(messagesFromNode);
            });

            console.log(`Total messages found across all logs: ${allMessages.length}`);

            if (allMessages.length === 0) {
                const datePart = syncDate.toLocaleDateString("en-US", { day: '2-digit', month: 'short', year: 'numeric' });
                const timePart = syncDate.toLocaleTimeString("en-US", { hour: '2-digit', minute: '2-digit', hour12: false });
                const readableTime = `${datePart.replace(',', '')}, ${timePart}`;

                lastSyncEl.textContent = `Last sync: ${readableTime} (No messages parsed)`;
                return;
            }

            // --- Rendering Logic ---

            allMessages.sort((a, b) => {
                const da = new Date(`${a.date} ${a.time}`);
                const db = new Date(`${b.date} ${b.time}`);
                if (isNaN(da) || isNaN(db)) return 0;
                return da - db;
            });

            let prevDate = "";

            allMessages.forEach(msg => {
                if (msg.date && msg.date !== prevDate) {
                    renderDateSeparator(msg.date);
                    prevDate = msg.date;
                }
                renderMessage(msg);
            });

            chatWindow.scrollTop = chatWindow.scrollHeight;

            // --- Update sync timestamp ---
            const datePart = syncDate.toLocaleDateString("en-US", { day: '2-digit', month: 'short', year: 'numeric' });
            const timePart = syncDate.toLocaleTimeString("en-US", { hour: '2-digit', minute: '2-digit', hour12: false });
            const readableTime = `${datePart.replace(',', '')}, ${timePart}`;

            lastSyncEl.textContent = `Last sync: ${readableTime}`;
        }

        // =========================================================================
        // DYNAMIC CONFIGURATION AND INITIALIZATION (UPDATED)
        // =========================================================================

        async function init() {
            console.log("Fetching Firebase configuration from firebase-config.json...");
            let firebaseConfig = null;

            try {
                // Fetch the config file (MUST be in the same directory)
                const response = await fetch('firebase-config.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - Check the file path and server settings.`);
                }
                firebaseConfig = await response.json();
            } catch (error) {
                console.error("‚ùå Could not load Firebase configuration:", error);
                lastSyncEl.textContent = "Last sync: ERROR loading config (See console)";
                return; // Stop execution if config fails
            }

            // Initialize Firebase with the fetched config
            try {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase initialized successfully.");

                // üü¢ CHANGE 2: NEW AUTHENTICATION LOGIC
                console.log("Attempting Anonymous Sign-in...");

                // Sign in anonymously and wait for the promise to resolve
                await firebase.auth().signInAnonymously();

                console.log("User successfully authenticated (anonymously).");

                // NOW that the user is authenticated, we can load the data
                loadLatest();
                // üü¢ END OF NEW AUTHENTICATION LOGIC

            } catch (e) {
                // This catch handles both initialization AND sign-in errors
                if (e.code === 'auth/operation-not-allowed') {
                    console.error("‚ùå Authentication Failed: Anonymous Auth is not enabled in Firebase Console.");
                } else if (e.code === 'permission_denied') {
                    // This error might show up in older SDK versions if rules fail
                    console.error("‚ùå Authentication Failed: Permission Denied. Check your security rules and API key restrictions.", e);
                } else {
                    console.error("‚ùå Firebase Initialization or Sign-in failed:", e);
                }
                lastSyncEl.textContent = "Last sync: ERROR (Auth/Permission Required)";
            }
        }


        refreshBtn.addEventListener("click", loadLatest);

        // Start the process by initializing
        init();
    </script>

    <!-- <div style="display:none;"><img src="images/chat.png" alt="Favicon Placeholder"></div> -->
</body>

</html>