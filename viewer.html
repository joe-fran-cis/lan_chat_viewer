<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LAN Chat — Viewer (History Only)</title>

    <style>
        body {
            font-family: Segoe UI, Roboto, Arial, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #09121a;
            color: #e6eef6;
        }

        #header {
            padding: 14px;
            background: #0f2630;
            color: #6fd6ff;
            text-align: center;
            font-size: 20px;
            font-weight: 600;
        }

        #status {
            padding: 12px;
            text-align: center;
            min-height: 32px;
            font-size: 14px;
            color: #bcd;
        }

        #chat-window {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        /* DATE SEPARATOR */
        .date-separator {
            text-align: center;
            color: #9ab;
            font-size: 13px;
            margin: 16px 0 10px;
            opacity: 0.8;
        }

        /* MESSAGE ROWS */
        .message-container {
            margin-bottom: 10px;
            display: flex;
            width: 100%;
        }

        .my-message {
            justify-content: flex-end;
        }

        .other-message {
            justify-content: flex-start;
        }

        /* MESSAGE BUBBLE */
        .bubble {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 16px;
            background: linear-gradient(to right, #003050, #005691);
            color: #fff;

            /* FIX LONG URL OVERFLOW */
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }

        /* PC messages = Light blue bubble */
        .pc {
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: #000;

            /* FIX LONG URL OVERFLOW */
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }

        .ts {
            display: block;
            margin-top: 6px;
            font-size: 0.75em;
            opacity: 0.8;
            text-align: right;
        }

        #controls {
            padding: 10px;
            background: #07121a;
            border-top: 1px solid #0f2736;
            text-align: center;
        }

        #refresh {
            padding: 10px 16px;
            border-radius: 7px;
            background: #1a8cff;
            border: 0;
            color: #fff;
            cursor: pointer;
            font-size: 15px;
        }

        #last-sync {
            margin-top: 6px;
            font-size: 13px;
            color: #9ab;
        }
    </style>
</head>

<body>
    <div id="header">LAN Chat — Viewer (History Only)</div>
    <div id="status">Initializing…</div>
    <div id="chat-window"></div>

    <div id="controls">
        <button id="refresh">Refresh</button>
        <div id="last-sync">Last sync: —</div>
    </div>

    <!-- Firebase (Compat mode for GitHub Pages) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBIUJAvCsMYeG38Sd2fRBR9ABT8X8NpQrY",
            authDomain: "lan-chat-f7896.firebaseapp.com",
            databaseURL: "https://lan-chat-f7896-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "lan-chat-f7896",
            storageBucket: "lan-chat-f7896.firebasestorage.app",
            messagingSenderId: "662426073276",
            appId: "1:662426073276:web:7c4dc65b2ef346a05278b9"
        };

        const statusEl = document.getElementById('status');
        const chatWindow = document.getElementById('chat-window');
        const lastSyncEl = document.getElementById('last-sync');

        function setStatus(msg) {
            statusEl.innerText = msg;
        }

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function formatDateLabel(dateStr) {
            // dateStr = "2025-09-30"
            const d = new Date(dateStr + "T00:00:00");

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);

            if (d.getTime() === today.getTime()) return "Today";
            if (d.getTime() === yesterday.getTime()) return "Yesterday";

            return d.toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function insertDateSeparator(dateStr) {
            const div = document.createElement("div");
            div.className = "date-separator";
            div.innerText = formatDateLabel(dateStr);
            chatWindow.appendChild(div);
        }

        function renderMessage(m) {
            const row = document.createElement("div");
            const bubble = document.createElement("div");

            const isMob = (m.source === "Mob"); // Mob messages → right side

            row.className = "message-container " + (isMob ? "my-message" : "other-message");

            bubble.className = "bubble " + ((m.source === "PC") ? "pc" : "");

            bubble.innerHTML =
                `${escapeHtml(m.message)}<span class="ts">${escapeHtml(m.time || "")}</span>`;

            row.appendChild(bubble);
            chatWindow.appendChild(row);
        }

        function escapeHtml(s) {
            return String(s)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
        }

        function normalizeArray(obj) {
            if (!obj) return [];
            if (Array.isArray(obj)) return obj;
            return Object.values(obj);
        }

        async function loadHistory() {
            chatWindow.innerHTML = "";
            setStatus("Loading chat history...");

            try {
                const snap = await db.ref("/chat_logs").limitToLast(1).once("value");

                if (!snap.exists()) {
                    setStatus("No chat logs found.");
                    return;
                }

                let last = null;
                snap.forEach(c => last = c.val());

                const data = normalizeArray(last.data);

                // Sort by date + time
                data.sort((a, b) =>
                    new Date(`${a.date} ${a.time}`) - new Date(`${b.date} ${b.time}`)
                );

                // Add DATE separators
                let currentDate = "";
                for (const msg of data) {
                    if (msg.date !== currentDate) {
                        currentDate = msg.date;
                        insertDateSeparator(currentDate);
                    }
                    renderMessage(msg);
                }

                chatWindow.scrollTop = chatWindow.scrollHeight;
                setStatus(`Loaded ${data.length} messages.`);
                lastSyncEl.innerText = "Last sync: " + (last.uploadedAt || new Date().toISOString());

            } catch (e) {
                console.error(e);
                setStatus("Error loading chat logs!");
            }
        }

        document.getElementById("refresh").addEventListener("click", loadHistory);

        loadHistory();
    </script>
</body>

</html>