<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LAN Chat — Viewer (Full History)</title>

    <style>
        body {
            font-family: Segoe UI, Roboto, Arial, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #09121a;
            color: #e6eef6;
        }

        #header {
            padding: 10px;
            background: #0f2630;
            color: #6fd6ff;
            text-align: center;
            font-weight: 600;
        }

        #status {
            padding: 12px;
            text-align: center;
            color: #bcd;
            min-height: 44px;
        }

        #chat-window {
            flex: 1;
            overflow: auto;
            padding: 12px;
        }

        .message-container {
            margin-bottom: 10px;
            display: flex;
        }

        .my-message {
            justify-content: flex-end;
        }

        .other-message {
            justify-content: flex-start;
        }

        .bubble {
            /* Compactness: Reduced max-width for desktop view */
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 18px;

            /* --- Wrapping Fix --- */
            /* Ensure words break aggressively for long URLs/strings */
            word-wrap: break-word;
            overflow-wrap: break-word;
            /* This is the key fix to break long strings at any character if needed */
            word-break: break-all;

            font-size: 0.95em;
            line-height: 1.4;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            text-align: left;
            /* Default: Mob/My Message (Blue/Cyan gradient) */
            background: linear-gradient(to right, #00f2fe, #4facfe);
            color: #000;
        }

        .other-message .bubble {
            /* PC/Other Message (Darker blue gradient) */
            background: linear-gradient(to right, #005691, #003050);
            color: white;
        }

        /* Style for links inside the bubble */
        .bubble a {
            color: inherit;
            text-decoration: underline;
        }

        .ts {
            display: block;
            margin-top: 6px;
            font-size: 0.75em;
            opacity: .8;
            text-align: right;
        }

        /* WhatsApp DATE style */
        .date-sep {
            display: inline-block;
            margin: 15px auto;
            padding: 6px 14px;
            background: #262d33;
            color: #cfd3d7;
            font-size: 0.78em;
            border-radius: 12px;
            text-align: center;
        }

        #controls {
            padding: 8px;
            background: #07121a;
            border-top: 1px solid #0f2736;
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
        }

        button {
            padding: 8px 12px;
            border-radius: 6px;
            border: 0;
            background: #1976d2;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #1565c0;
        }

        @media (max-width: 600px) {
            .bubble {
                /* Compactness: Reduced max-width for mobile view */
                max-width: 85%;
            }
        }
    </style>
</head>

<body>
    <div id="status" style="display:none;"></div>

    <div id="chat-window"></div>

    <div id="controls">
        <button id="refresh">Refresh</button>
        <div id="last-sync" style="font-size: 0.9em; color:#9ab;">Last sync: —</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <script>
        // DOM Element references
        const statusEl = document.getElementById("status");
        const chatWindow = document.getElementById("chat-window");
        const lastSyncEl = document.getElementById("last-sync");
        const refreshBtn = document.getElementById("refresh");

        /**
         * Safely escapes HTML characters in a string.
         * @param {string} t The text to escape.
         */
        function escapeHtml(t) {
            return t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        /**
         * Converts text containing URLs into HTML with clickable links.
         * @param {string} text The text to linkify.
         */
        function linkify(text) {
            const urlRegex = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[\S]+(\b|$))|(\b[\w]+(\.[\w]{2,}){1,3}\b)/gim;
            const escapedText = escapeHtml(text);

            const linkedText = escapedText.replace(urlRegex, (url) => {
                let href = url;
                if (!url.match(/^(https?|ftp):\/\//i) && url.indexOf('.') > -1) {
                    href = 'http://' + url;
                }
                return `<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
            });

            return linkedText;
        }

        /**
         * Converts a Firebase object map into a clean array of message objects.
         * Used for handling older, multi-message node structures.
         * @param {object} obj The object map from Firebase.
         */
        function normalizeToArray(obj) {
            if (!obj || typeof obj !== 'object') return [];
            
            const values = Object.values(obj);
            return values.filter(item => {
                const isObject = typeof item === 'object' && item !== null;
                const isMessage = isObject && (item.message || item.msg);
                return isMessage;
            });
        }

        /**
         * Formats a date string for display in the date separator.
         * @param {string} dateStr The date string (e.g., "YYYY-MM-DD").
         */
        function formatDateForDisplay(dateStr) {
            const d = new Date(dateStr);
            if (isNaN(d)) return dateStr;

            const today = new Date();
            const yest = new Date();
            yest.setDate(today.getDate() - 1);

            const sameDay = (a, b) => a.toDateString() === b.toDateString();

            if (sameDay(d, today)) return "Today";
            if (sameDay(d, yest)) return "Yesterday";

            // Format as "21 Nov 2025"
            return d.toLocaleDateString("en-US", {
                day: "2-digit",
                month: "short",
                year: "numeric"
            });
        }

        /**
         * Renders a date separator element in the chat window.
         * @param {string} dateString The date string for the separator.
         */
        function renderDateSeparator(dateString) {
            const wrap = document.createElement("div");
            wrap.style.display = "flex";
            wrap.style.justifyContent = "center";

            const sep = document.createElement("div");
            sep.className = "date-sep";
            sep.textContent = formatDateForDisplay(dateString);

            wrap.appendChild(sep);
            chatWindow.appendChild(wrap);
        }

        /**
         * Renders a single message bubble.
         * @param {object} msg The message object.
         */
        function renderMessage(msg) {
            const isMyMessage = msg.source === "Mob";
            const container = document.createElement("div");
            container.className =
                "message-container " + (isMyMessage ? "my-message" : "other-message");

            const bubble = document.createElement("div");
            bubble.className = "bubble";

            const text = msg.message ?? msg.msg ?? "";
            const time = msg.time ?? "";

            const linkedText = linkify(text);

            bubble.innerHTML =
                linkedText + `<span class="ts">${escapeHtml(time)}</span>`;

            container.appendChild(bubble);
            chatWindow.appendChild(container);
        }
        
        // =========================================================================
        // CORE DATA LOADING FUNCTION
        // =========================================================================
        
        async function loadLatest() {
            console.log("Starting full history data load...");
            chatWindow.innerHTML = "";
            let allMessages = [];

            // We assume Firebase is already initialized by init()
            const db = firebase.database();
            
            // --- Querying ALL log entries ---
            const snap = await db.ref("/chat_logs").once("value");

            const syncDate = new Date();

            if (!snap.exists()) {
                lastSyncEl.textContent = "Last sync: No chat logs found";
                return;
            }

            snap.forEach(childSnapshot => {
                const nodeData = childSnapshot.val();
                const messageBlock = nodeData.data ?? nodeData;

                let messagesFromNode = [];

                if (messageBlock && (messageBlock.message || messageBlock.msg)) {
                    messagesFromNode = [messageBlock];
                } else {
                    messagesFromNode = normalizeToArray(messageBlock);
                }

                allMessages = allMessages.concat(messagesFromNode);
            });

            console.log(`Total messages found across all logs: ${allMessages.length}`);

            if (allMessages.length === 0) {
                const datePart = syncDate.toLocaleDateString("en-US", { day: '2-digit', month: 'short', year: 'numeric' });
                const timePart = syncDate.toLocaleTimeString("en-US", { hour: '2-digit', minute: '2-digit', hour12: false });
                const readableTime = `${datePart.replace(',', '')}, ${timePart}`;

                lastSyncEl.textContent = `Last sync: ${readableTime} (No messages parsed)`;
                return;
            }

            // --- Rendering Logic ---

            // Sort ALL messages chronologically
            allMessages.sort((a, b) => {
                const da = new Date(`${a.date} ${a.time}`);
                const db = new Date(`${b.date} ${b.time}`);
                if (isNaN(da) || isNaN(db)) return 0;
                return da - db;
            });

            let prevDate = "";

            allMessages.forEach(msg => {
                if (msg.date && msg.date !== prevDate) {
                    renderDateSeparator(msg.date);
                    prevDate = msg.date;
                }
                renderMessage(msg);
            });

            chatWindow.scrollTop = chatWindow.scrollHeight;

            // --- Update sync timestamp ---
            const datePart = syncDate.toLocaleDateString("en-US", { day: '2-digit', month: 'short', year: 'numeric' });
            const timePart = syncDate.toLocaleTimeString("en-US", { hour: '2-digit', minute: '2-digit', hour12: false });
            const readableTime = `${datePart.replace(',', '')}, ${timePart}`;

            lastSyncEl.textContent = `Last sync: ${readableTime}`;
        }
        
        // =========================================================================
        // DYNAMIC CONFIGURATION AND INITIALIZATION
        // =========================================================================

        async function init() {
            console.log("Fetching Firebase configuration from firebase-config.json...");
            let firebaseConfig = null;

            try {
                // Fetch the config file (MUST be in the same directory)
                const response = await fetch('firebase-config.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - Check the file path and server settings.`);
                }
                firebaseConfig = await response.json();
            } catch (error) {
                console.error("❌ Could not load Firebase configuration:", error);
                lastSyncEl.textContent = "Last sync: ERROR loading config (See console)";
                return; // Stop execution if config fails
            }

            // Initialize Firebase with the fetched config
            try {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase initialized successfully.");
                // Now, load the chat data
                loadLatest();
            } catch (e) {
                console.error("❌ Firebase initialization failed:", e);
                lastSyncEl.textContent = "Last sync: ERROR initializing Firebase";
            }
            
        }


        refreshBtn.addEventListener("click", loadLatest);
        
        // Start the process by initializing
        init();
    </script>
    
    <div style="display:none;"><img src="images/chat.png" alt="Favicon Placeholder"></div>
</body>

</html>