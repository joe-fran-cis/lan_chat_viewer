<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LAN Chat — Viewer (History Only)</title>

    <style>
        body {
            font-family: Segoe UI, Roboto, Arial, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #09121a;
            color: #e6eef6;
        }

        #header {
            padding: 10px;
            background: #0f2630;
            color: #6fd6ff;
            text-align: center;
            font-weight: 600;
        }

        #status {
            padding: 12px;
            text-align: center;
            color: #bcd;
            min-height: 44px;
        }

        #chat-window {
            flex: 1;
            overflow: auto;
            padding: 12px;
        }

        .message-container {
            margin-bottom: 10px;
            display: flex;
        }

        .my-message {
            justify-content: flex-end;
            /* Mob → right */
        }

        .other-message {
            justify-content: flex-start;
            /* PC → left */
        }

        .bubble {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 16px;
            background: linear-gradient(to right, #003050, #005691);
            color: #fff;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }

        .pc {
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: #000;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }

        .ts {
            display: block;
            margin-top: 6px;
            font-size: 0.75em;
            opacity: .8;
            text-align: right;
        }

        /* WhatsApp DATE style */
        .date-sep {
            display: inline-block;
            margin: 15px auto;
            padding: 6px 14px;
            background: #262d33;
            color: #cfd3d7;
            font-size: 0.78em;
            border-radius: 12px;
            text-align: center;
        }

        #controls {
            padding: 8px;
            background: #07121a;
            border-top: 1px solid #0f2736;
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
        }

        button {
            padding: 8px 12px;
            border-radius: 6px;
            border: 0;
            background: #1976d2;
            color: #fff;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <!-- <div id="header">LAN Chat — Viewer (History Only)</div> -->
    <!-- <div id="status">Initializing…</div> -->
    <div id="chat-window"></div>

    <div id="controls">
        <button id="refresh">Refresh</button>
        <div id="last-sync" style="font-size: 0.9em; color:#9ab;">Last sync: —</div>
    </div>

    <!-- Firebase compat -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBIUJAvCsMYeG38Sd2fRBR9ABT8X8NpQrY",
            authDomain: "lan-chat-f7896.firebaseapp.com",
            databaseURL: "https://lan-chat-f7896-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "lan-chat-f7896",
            storageBucket: "lan-chat-f7896.firebasestorage.app",
            messagingSenderId: "662426073276",
            appId: "1:662426073276:web:7c4dc65b2ef346a05278b9"
        };

        const statusEl = document.getElementById("status");
        const chatWindow = document.getElementById("chat-window");
        const lastSyncEl = document.getElementById("last-sync");
        const refreshBtn = document.getElementById("refresh");

        function setStatus(text, err = false) {
            statusEl.textContent = text;
            statusEl.style.color = err ? "#ffd2d2" : "#bcd";
        }

        function escapeHtml(t) {
            return t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        function normalizeToArray(obj) {
            if (!obj) return [];
            if (Array.isArray(obj)) return obj;

            const keys = Object.keys(obj);
            const numeric = keys.every(k => /^\d+$/.test(k));
            if (numeric) return keys.sort((a, b) => a - b).map(k => obj[k]);

            return keys.map(k => obj[k]);
        }

        function formatDateForDisplay(dateStr) {
            const d = new Date(dateStr);
            if (isNaN(d)) return dateStr;

            const today = new Date();
            const yest = new Date();
            yest.setDate(today.getDate() - 1);

            const sameDay = (a, b) => a.toDateString() === b.toDateString();

            if (sameDay(d, today)) return "Today";
            if (sameDay(d, yest)) return "Yesterday";

            return d.toLocaleDateString("en-IN", {
                day: "2-digit",
                month: "short",
                year: "numeric"
            });
        }

        function renderDateSeparator(dateString) {
            const wrap = document.createElement("div");
            wrap.style.display = "flex";
            wrap.style.justifyContent = "center";

            const sep = document.createElement("div");
            sep.className = "date-sep";
            sep.textContent = formatDateForDisplay(dateString);

            wrap.appendChild(sep);
            chatWindow.appendChild(wrap);
        }

        function renderMessage(msg) {
            const container = document.createElement("div");
            container.className =
                "message-container " + (msg.source === "Mob" ? "my-message" : "other-message");

            const bubble = document.createElement("div");
            bubble.className = "bubble" + (msg.source === "PC" ? " pc" : "");

            const text = msg.message ?? msg.msg ?? "";
            const time = msg.time ?? "";

            bubble.innerHTML =
                escapeHtml(text) + `<span class="ts">${escapeHtml(time)}</span>`;

            container.appendChild(bubble);
            chatWindow.appendChild(container);
        }

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        async function loadLatest() {
            //  setStatus("Loading...");

            chatWindow.innerHTML = "";

            const snap = await db.ref("/chat_logs").limitToLast(1).once("value");

            if (!snap.exists()) {
                //setStatus("No chat history found.", true);
                return;
            }

            let last = null;
            snap.forEach(c => last = c.val());

            const block = last.data ?? last;
            const arr = normalizeToArray(block);

            if (arr.length === 0) {
                //setStatus("History empty.", true);
                return;
            }

            arr.sort((a, b) => {
                const da = new Date(`${a.date} ${a.time}`);
                const db = new Date(`${b.date} ${b.time}`);
                return da - db;
            });

            let prevDate = "";

            arr.forEach(msg => {
                if (msg.date !== prevDate) {
                    renderDateSeparator(msg.date);
                    prevDate = msg.date;
                }
                renderMessage(msg);
            });

            chatWindow.scrollTop = chatWindow.scrollHeight;

            lastSyncEl.textContent =
                "Last sync: " + (last.uploadedAt || new Date().toISOString());

            //setStatus(`Loaded ${arr.length} messages.`);
        }

        refreshBtn.addEventListener("click", loadLatest);
        loadLatest();
    </script>

</body>

</html>